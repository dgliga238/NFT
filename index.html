<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Luna AR NFT Experience</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

  <!-- A-Frame (NFT build works with 1.2.0) -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <!-- AR.js NFT build -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>

  <style>
    body { margin:0; overflow:hidden; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    #ui-overlay {
      position: fixed; top: 0; left: 0; right: 0;
      padding: 10px 14px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.75), rgba(0,0,0,0));
      color: #fff; font-size: 13px; z-index: 10;
    }
    #ui-overlay h1 { margin: 0 0 4px 0; font-size: 15px; }
    #ui-overlay p  { margin: 0; line-height: 1.3; }
  </style>
</head>

<body>
<div id="ui-overlay">
  <h1>Luna, the Portal Cat</h1>
  <p>1) Point the camera at your NFT marker image.<br/>
     2) When Luna appears, tap to continue the story.<br/>
     3) Watch her world transform as you interact.</p>
</div>

<a-scene
  embedded
  vr-mode-ui="enabled: false"
  renderer="logarithmicDepthBuffer: true; alpha: true; physicallyCorrectLights: true"
  arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: false">

  <!-- Lights -->
  <a-entity light="type: ambient; intensity: 1"></a-entity>
  <a-entity light="type: directional; intensity: 0.9" position="1 1 1"></a-entity>

  <!-- NFT Marker -->
  <!-- Place pinball2.fset, pinball2.fset3, pinball2.iset in ./nft/pinball2/ -->
  <a-nft id="catMarker" type="nft" url="./nft/pinball2/pinball2" emitevents="true">

    <!-- Main card with your image -->
    <a-plane id="catCard"
      position="0 0 0"
      rotation="-90 0 0"
      width="1.2" height="1.2"
      material="src: url(./nft/pinball2.jpg); opacity: 0.98; transparent: true; shader: standard; emissive: #ff8ad9; emissiveIntensity: 0.5; side: double;">
    </a-plane>

    <!-- Glowing aura -->
    <a-ring id="aura"
      position="0 0 0"
      rotation="-90 0 0"
      radius-inner="0.7" radius-outer="0.95"
      material="color: #ffb3ec; opacity: 0.65; transparent: true"
      animation__pulse_scale="property: scale; from: 1 1 1; to: 1.15 1.15 1.15; dir: alternate; loop: true; dur: 1400"
      animation__pulse_opacity="property: material.opacity; from: 0.35; to: 0.9; dir: alternate; loop: true; dur: 1400">
    </a-ring>

    <!-- Story text -->
    <a-text id="storyText"
      value="Scan the marker to wake up Luna."
      color="#ffd6ff"
      align="center"
      position="0 0.8 0.1"
      rotation="-90 0 0"
      width="2"
      shader="msdf" negate="false">
    </a-text>

    <!-- Small stars (hidden initially) -->
    <a-entity id="stars" visible="false">
      <a-sphere radius="0.05" position="-0.5 0.2 0.2" material="color: #fff5ff; emissive: #ffc8ff; emissiveIntensity: 0.8;"></a-sphere>
      <a-sphere radius="0.04" position="0.4 0.1 -0.1" material="color: #e0f0ff; emissive: #a5d8ff; emissiveIntensity: 0.7;"></a-sphere>
      <a-sphere radius="0.03" position="-0.2 0.25 -0.3" material="color: #ffe9ff; emissive: #ffc8ff; emissiveIntensity: 0.8;"></a-sphere>
    </a-entity>

    <!-- Portal (hidden initially) -->
    <a-ring id="portal"
      position="0 0 0"
      rotation="-90 0 0"
      radius-inner="0.35" radius-outer="0.65"
      visible="false"
      material="color: #ff8ad9; emissive: #b57dff; opacity: 0.9; transparent: true; metalness: 0.2; roughness: 0.1;"
      animation__spin="property: rotation; to: -90 360 0; loop: true; dur: 8000; easing: linear">
    </a-ring>

    <!-- Heart (hidden initially) -->
    <a-entity id="heart" visible="false" position="0 0.15 0" scale="0.4 0.4 0.4">
      <a-entity geometry="primitive: sphere; radius: 0.18" material="color: #ff6b81; emissive: #ff3b6b; emissiveIntensity: 0.9" position="-0.1 0 0"></a-entity>
      <a-entity geometry="primitive: sphere; radius: 0.18" material="color: #ff6b81; emissive: #ff3b6b; emissiveIntensity: 0.9" position="0.1 0 0"></a-entity>
      <a-entity geometry="primitive: cone; height: 0.4; radiusBottom: 0.26; radiusTop: 0.02" material="color: #ff6b81; emissive: #ff3b6b; emissiveIntensity: 0.9" position="0 -0.15 0" rotation="180 0 0"></a-entity>
      <a-animation attribute="scale" dur="1000" from="0.4 0.4 0.4" to="0.5 0.5 0.5" direction="alternate" repeat="indefinite"></a-animation>
    </a-entity>

  </a-nft>

  <a-entity camera></a-entity>
</a-scene>

<script>
  const marker = document.getElementById('catMarker');
  const catCard = document.getElementById('catCard');
  const aura = document.getElementById('aura');
  const stars = document.getElementById('stars');
  const portal = document.getElementById('portal');
  const heart = document.getElementById('heart');
  const storyText = document.getElementById('storyText');
  const scene = document.querySelector('a-scene');

  let phase = 0;
  let messageIndex = 0;

  const phase1Messages = ["Tap to enter Luna's dreamscape."];
  const phase2Messages = [
    "The portal hums with gentle energy.",
    "Colors shift as Luna peers through.",
    "The air shimmers. Tap again."
  ];
  const phase3Messages = [
    "A warm heart glows for Luna.",
    "She purrs softly. Tap to replay."
  ];

  function setCardVisible(v) {
    catCard.setAttribute('visible', v);
    aura.setAttribute('visible', v);
  }

  function resetState() {
    phase = 0;
    messageIndex = 0;
    setCardVisible(true);
    stars.setAttribute('visible', false);
    portal.setAttribute('visible', false);
    heart.setAttribute('visible', false);
    storyText.setAttribute('value', "Scan the marker to wake up Luna. Tap to begin.");
  }

  marker.addEventListener('markerFound', () => {
    resetState();
  });

  marker.addEventListener('markerLost', () => {
    storyText.setAttribute('value', "Marker lost. Point back at the image.");
  });

  function onTap() {
    // Phase 0: initial tap
    if (phase === 0) {
      stars.setAttribute('visible', true);
      storyText.setAttribute('value', phase1Messages[0]);
      phase = 1;
      return;
    }
    // Phase 1: show stars, move to portal
    if (phase === 1) {
      setCardVisible(false);
      portal.setAttribute('visible', true);
      storyText.setAttribute('value', phase2Messages[0]);
      phase = 2;
      messageIndex = 0;
      return;
    }
    // Phase 2: cycle portal messages/colors
    if (phase === 2) {
      messageIndex = (messageIndex + 1) % phase2Messages.length;
      storyText.setAttribute('value', phase2Messages[messageIndex]);

      const colors = ["#ff8ad9", "#ffb347", "#8ad9ff"];
      const emissives = ["#b57dff", "#ff9dbb", "#7dc9ff"];
      const idx = messageIndex % colors.length;
      portal.setAttribute('material',
        "color: " + colors[idx] +
        "; emissive: " + emissives[idx] +
        "; opacity: 0.9; transparent: true; metalness: 0.2; roughness: 0.1;");
      if (messageIndex === phase2Messages.length - 1) {
        phase = 3;
        messageIndex = 0;
        storyText.setAttribute('value', "Tap to send Luna a glowing heart.");
      }
      return;
    }
    // Phase 3: show heart
    if (phase === 3) {
      heart.setAttribute('visible', true);
      storyText.setAttribute('value', phase3Messages[0]);
      phase = 4;
      return;
    }
    // Phase 4: ending + replay
    if (phase === 4) {
      messageIndex += 1;
      if (messageIndex < phase3Messages.length) {
        storyText.setAttribute('value', phase3Messages[messageIndex]);
      } else {
        resetState();
      }
      return;
    }
  }

  scene.addEventListener('click', onTap);
  scene.addEventListener('touchend', onTap);
</script>
</body>
</html>
