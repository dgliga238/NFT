<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Luna AR NFT Experience</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <!-- AR.js NFT -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        #ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px 14px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.75), rgba(0,0,0,0));
            color: #fff;
            font-size: 13px;
            z-index: 10;
        }
        #ui-overlay h1 {
            margin: 0 0 4px 0;
            font-size: 15px;
        }
        #ui-overlay p {
            margin: 0;
            line-height: 1.3;
        }
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 100;
            text-align: center;
        }
        .hidden {
            display: none;
        }
    </style>
</head>

<body>
<div id="loading">
    <h2>üêæ Loading Luna...</h2>
    <p>Please allow camera access</p>
</div>

<div id="ui-overlay" class="hidden">
    <h1>üêæ Luna, the Portal Cat</h1>
    <p>
        1Ô∏è‚É£ Point the camera at your NFT marker with the cat image.<br/>
        2Ô∏è‚É£ When Luna appears, tap on the screen to continue the story.<br/>
        3Ô∏è‚É£ Watch her world transform as you interact.
    </p>
</div>

<a-scene
    embedded
    vr-mode-ui="enabled: false"
    renderer="colorManagement: true; physicallyCorrectLights: true"
    arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
>
    <!-- Lights -->
    <a-entity light="type: ambient; intensity: 1"></a-entity>
    <a-entity light="type: directional; intensity: 0.9" position="1 1 1"></a-entity>

    <!-- NFT Marker - path should NOT include file extension -->
    <a-nft
        id="catMarker"
        type="nft"
        url="./nft/eye"
        smooth="true"
        smoothCount="10"
        smoothTolerance="0.01"
        smoothThreshold="5"
    >

        <!-- Main card with the anime cat image -->
        <a-plane
            id="catCard"
            position="0 0 0"
            rotation="-90 0 0"
            width="1.2"
            height="1.2"
            material="
                src: url(./models/eye.png);
                opacity: 0.95;
                transparent: true;
                shader: standard;
                emissive: #ff8ad9;
                emissiveIntensity: 0.6;">
        </a-plane>

        <!-- Soft glowing aura around the card -->
        <a-ring id="aura"
                position="0 0 0"
                rotation="-90 0 0"
                radius-inner="0.7"
                radius-outer="0.9"
                material="color: #ffb3ec; opacity: 0.7; transparent: true"
                animation__pulse_scale="
                    property: scale;
                    from: 1 1 1;
                    to: 1.15 1.15 1.15;
                    dir: alternate;
                    loop: true;
                    dur: 1400"
                animation__pulse_opacity="
                    property: material.opacity;
                    from: 0.4;
                    to: 0.9;
                    dir: alternate;
                    loop: true;
                    dur: 1400">
        </a-ring>

        <!-- Story text -->
        <a-text id="storyText"
                value="üì∏ Tap to wake up Luna."
                color="#ffd6ff"
                align="center"
                position="0 0.8 0.1"
                rotation="-90 0 0"
                width="2"
                shader="msdf"
                negate="false">
        </a-text>

        <!-- Small stars for Luna's dream world (hidden at first) -->
        <a-entity id="stars" visible="false">
            <a-sphere radius="0.05"
                      position="-0.5 0.2 0.2"
                      material="color: #fff5ff; emissive: #ffc8ff; emissiveIntensity: 0.8;">
            </a-sphere>
            <a-sphere radius="0.04"
                      position="0.4 0.1 -0.1"
                      material="color: #e0f0ff; emissive: #9ad8ff; emissiveIntensity: 0.8;">
            </a-sphere>
            <a-sphere radius="0.03"
                      position="0.1 0.3 0.3"
                      material="color: #fff0f5; emissive: #ffb6e1; emissiveIntensity: 0.9;">
            </a-sphere>
        </a-entity>

        <!-- Portal disc (hidden at first) -->
        <a-ring id="portal"
                visible="false"
                position="0 0 0.02"
                rotation="-90 0 0"
                radius-inner="0.3"
                radius-outer="0.7"
                material="color: #ff8ad9; emissive: #b57dff; opacity: 0.9;
                          transparent: true; metalness: 0.2; roughness: 0.1;"
                animation__spin="
                    property: rotation;
                    from: -90 0 0;
                    to: -90 360 0;
                    loop: true;
                    dur: 6000;
                    easing: linear">
        </a-ring>

        <!-- Glowing heart for the ending (hidden at first) -->
        <a-sphere id="heart"
                  visible="false"
                  position="0 0.3 0.1"
                  radius="0.15"
                  material="color: #ff6fae; emissive: #ff9ad4; emissiveIntensity: 1;
                            opacity: 0.95; transparent: true">
        </a-sphere>

    </a-nft>

    <!-- AR Camera -->
    <a-entity camera></a-entity>
</a-scene>

<script>
    // Wait until A-Frame and the scene are ready
    window.addEventListener('load', function () {
        const sceneEl = document.querySelector('a-scene');
        const loadingEl = document.getElementById('loading');
        const uiOverlay = document.getElementById('ui-overlay');
        const marker = document.querySelector('#catMarker');

        const catCard   = document.querySelector('#catCard');
        const aura      = document.querySelector('#aura');
        const storyText = document.querySelector('#storyText');
        const stars     = document.querySelector('#stars');
        const portal    = document.querySelector('#portal');
        const heart     = document.querySelector('#heart');

        // Hide loading screen when AR is ready
        sceneEl.addEventListener('renderstart', function() {
            loadingEl.classList.add('hidden');
            uiOverlay.classList.remove('hidden');
        });

        // Listen for marker found/lost events
        marker.addEventListener('markerFound', function() {
            console.log('Marker detected!');
            uiOverlay.querySelector('p').innerHTML = 
                '‚úÖ <strong>Marker detected!</strong><br/>' +
                'Tap on the screen to continue Luna\'s story.';
        });

        marker.addEventListener('markerLost', function() {
            console.log('Marker lost');
            uiOverlay.querySelector('p').innerHTML = 
                '‚ö†Ô∏è Marker lost - point camera at marker<br/>' +
                'Keep the marker in view and well-lit.';
        });

        // Story phases
        let phase = 0;
        let messageIndex = 0;

        const phase0Messages = [
            "üì∏ Tap to wake up Luna.",
            "üëÄ She blinks slowly, noticing you."
        ];

        const phase1Messages = [
            "‚ú® Stars appear around Luna.",
            "üåô A portal to her dream world opens..."
        ];

        const phase2Messages = [
            "üåå Luna steps into the portal.",
            "üåÄ Colors swirl as she jumps between worlds.",
            "üö™ Doors of light open in every direction."
        ];

        const phase3Messages = [
            "üíñ You send Luna a glowing heart.",
            "üêæ She purrs and promises to visit again soon.",
            "üîÅ Tap once more to replay her story."
        ];

        // Helper: show/hide the main card and aura
        function setCardVisible(visible) {
            catCard.setAttribute('visible', visible);
            aura.setAttribute('visible', visible);
        }

        // Tap anywhere on the scene to progress the story
        sceneEl.addEventListener('click', function () {
            // Phase 0: wake up Luna on the card
            if (phase === 0) {
                messageIndex = (messageIndex + 1) % phase0Messages.length;
                storyText.setAttribute('value', phase0Messages[messageIndex]);

                if (messageIndex === phase0Messages.length - 1) {
                    phase = 1;
                    messageIndex = 0;
                }
            }
            // Phase 1: stars appear around the card
            else if (phase === 1) {
                stars.setAttribute('visible', true);
                storyText.setAttribute('value', phase1Messages[0]);
                phase = 2;
                messageIndex = 0;
            }
            // Phase 2: switch from card to portal world
            else if (phase === 2) {
                setCardVisible(false);
                stars.setAttribute('visible', true);
                portal.setAttribute('visible', true);
                storyText.setAttribute('value', phase2Messages[0]);
                phase = 2.5;
                messageIndex = 0;
            }
            // Phase 2.5: interact with the portal, cycle messages and colors
            else if (phase === 2.5) {
                messageIndex = (messageIndex + 1) % phase2Messages.length;
                storyText.setAttribute('value', phase2Messages[messageIndex]);

                const colors    = ["#ff8ad9", "#ffb347", "#8ad9ff", "#c38dff"];
                const emissives = ["#b57dff", "#ff9dbb", "#7dc9ff", "#ff9df2"];
                const idx = messageIndex % colors.length;

                portal.setAttribute(
                    'material',
                    "color: " + colors[idx] +
                    "; emissive: " + emissives[idx] +
                    "; opacity: 0.9; transparent: true; metalness: 0.2; roughness: 0.1;"
                );

                if (messageIndex === phase2Messages.length - 1) {
                    phase = 3;
                    messageIndex = 0;
                    storyText.setAttribute('value', "üíñ Tap again to send Luna a glowing heart.");
                }
            }
            // Phase 3: heart appears
            else if (phase === 3) {
                heart.setAttribute('visible', true);
                storyText.setAttribute('value', phase3Messages[0]);
                phase = 3.5;
                messageIndex = 0;
            }
            // Phase 3.5: ending + replay
            else if (phase === 3.5) {
                messageIndex = messageIndex + 1;
                if (messageIndex < phase3Messages.length) {
                    storyText.setAttribute('value', phase3Messages[messageIndex]);
                } else {
                    phase = 0;
                    messageIndex = 0;
                    setCardVisible(true);
                    stars.setAttribute('visible', false);
                    portal.setAttribute('visible', false);
                    heart.setAttribute('visible', false);
                    storyText.setAttribute(
                        'value',
                        "üì∏ Tap to wake up Luna again."
                    );
                }
            }
        });
    });
</script>

</body>
</html>