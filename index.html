<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>NFT AR Interaction Lab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

<!-- A-Frame (use 1.2.0 with AR.js NFT) -->
<script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>

<!-- AR.js NFT -->
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>

  <style>
    body { margin:0; overflow:hidden; }
    .hud {
      position: fixed; bottom: 14px; left: 50%; transform: translateX(-50%);
      display: grid; grid-template-columns: repeat(5, auto); gap: 8px;
      font: 600 14px system-ui;
      z-index: 10; pointer-events: none;
    }
    .hud.hidden { display:none; }
    .hud button {
      pointer-events:auto;
      padding:10px 12px; border:0; border-radius:10px;
      background:rgba(255,255,255,.9);
    }
  </style>

  <script>
    console.log('Script loading...');  /* keeps console logs, not on-screen */

    const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));

    /* All gesture components kept exactly as they were */
    AFRAME.registerComponent('tap-gestures', {
      schema: {longMs:{default:500}},
      init () {
        let lastTap = 0, pressTimer = null, down = false;
        this.el.addEventListener('mousedown', () => {
          down = true;
          const now = performance.now();
          if (now - lastTap < 300) this.el.emit('doubletap');
          lastTap = now;
          pressTimer = setTimeout(() => { if (down) this.el.emit('longpress'); }, this.data.longMs);
        });
        this.el.addEventListener('mouseup', () => {
          down = false;
          clearTimeout(pressTimer);
          this.el.emit('tap');
        });
      }
    });

    AFRAME.registerComponent('pinch-scale', {
      schema:{min:{default:0.2}, max:{default:3}},
      init(){
        this.active=false; this.startD=0; this.startScale=null;
        const dist=(a,b)=>Math.hypot(a.clientX-b.clientX,a.clientY-b.clientY);

        this.el.addEventListener('touchstart',(e)=>{
          if(e.touches.length===2){
            e.stopPropagation();
            this.active=true;
            this.startD=dist(e.touches[0],e.touches[1]);
            this.startScale={...this.el.getAttribute('scale')};
          }
        },{passive:false});

        this.el.addEventListener('touchmove',(e)=>{
          if(!this.active||e.touches.length<2) return;
          e.stopPropagation();
          const d=dist(e.touches[0],e.touches[1]);
          const mult=d/this.startD;
          const s=this.startScale;
          this.el.setAttribute('scale',{
            x: clamp(s.x*mult,this.data.min,this.data.max),
            y: clamp(s.y*mult,this.data.min,this.data.max),
            z: clamp(s.z*mult,this.data.min,this.data.max)
          });
        },{passive:false});

        this.el.addEventListener('touchend',()=>this.active=false);
      }
    });

    AFRAME.registerComponent('one-finger-rotate', {
      schema:{sensitivity:{default:0.5}},
      init(){
        this.active=false; this.startX=0; this.startRotY=0;

        this.el.addEventListener('touchstart',(e)=>{
          if(e.touches.length===1){
            e.stopPropagation();
            this.active=true;
            this.startX=e.touches[0].clientX;
            this.startRotY=this.el.getAttribute('rotation').y;
          }
        },{passive:false});

        this.el.addEventListener('touchmove',(e)=>{
          if(!this.active||e.touches.length!==1) return;
          e.stopPropagation();
          const deltaX = e.touches[0].clientX - this.startX;
          const rotation = this.startRotY + (deltaX * this.data.sensitivity);
          const r=this.el.getAttribute('rotation');
          this.el.setAttribute('rotation',{x:r.x,y:rotation,z:r.z});
        },{passive:false});

        this.el.addEventListener('touchend',()=>this.active=false);
      }
    });
  </script>
</head>

<body>

  <!-- HUD only (removed debug overlay) -->
  <div class="hud" id="hud">
    <button id="btn-rot-l">âŸ²</button>
    <button id="btn-rot-r">âŸ³</button>
    <button id="btn-scale--">âˆ’</button>
    <button id="btn-scale-+">ï¼‹</button>
    <button id="btn-color">ðŸŽ¨</button>
  </div>

  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true; alpha: true;"
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false">

<!-- FIRST MARKER -->
<a-nft
  type="nft"
  url="./nft/dali"
  smooth="true"
  smoothCount="10"
  smoothTolerance="0.01"
  emitevents="true">

 <a-entity id="main-text"
          position="0 30 20"
          rotation="-30 0 0"
          scale="50 50 50">

  <a-plane width="6" height="3" color="#000" opacity="0"></a-plane>

  <a-text
    position="0 0 0.15"
    align="center"
    color="#ff0000"
    width="6"
    wrap-count="18"
    value="SHOW ME ONE OF MY WORKS">
  </a-text>

</a-entity>
</a-nft>


<!-- SECOND MARKER -->
<a-nft
  id="marker-dali3"
  type="nft"
  url="./nft/dali3"
  smooth="true"
  smoothCount="10"
  smoothTolerance="0.01"
  emitevents="true">

  <a-entity id="panel2"
            visible="false"
            position="0 0 0"
            scale="30 30 30"
            pinch-scale
            one-finger-rotate>

      <a-gltf-model
        id="model2"
        src="./models/CheckMark.glb"
        position="0 0 0"
        rotation="-90 0 0">
      </a-gltf-model>

  </a-entity>
</a-nft>

  <a-entity camera></a-entity>
</a-scene>

<script>
let daliScanned = false;

window.addEventListener('load', () => {

  const marker1 = document.querySelector('a-nft[type="nft"]');
  const marker2 = document.querySelector('#marker-dali3');
  const panel2 = document.getElementById('panel2');

  // BUTTONS
  const btnRotL = document.getElementById('btn-rot-l');
  const btnRotR = document.getElementById('btn-rot-r');
  const btnScaleMinus = document.getElementById('btn-scale--');
  const btnScalePlus = document.getElementById('btn-scale-+');
  const btnColor = document.getElementById('btn-color');

  const rotStep = 15;
  const scaleStep = 1.2;
  const minScale = 10;
  const maxScale = 150;

  btnRotL.onclick = () => {
    if (!panel2.getAttribute('visible')) return;
    const r = panel2.getAttribute('rotation');
    panel2.setAttribute('rotation',{x:r.x,y:r.y - rotStep,z:r.z});
  };
  btnRotR.onclick = () => {
    if (!panel2.getAttribute('visible')) return;
    const r = panel2.getAttribute('rotation');
    panel2.setAttribute('rotation',{x:r.x,y:r.y + rotStep,z:r.z});
  };

  btnScaleMinus.onclick = () => {
    if (!panel2.getAttribute('visible')) return;
    const s = panel2.getAttribute('scale');
    let n = Math.max(minScale, s.x / scaleStep);
    panel2.setAttribute('scale',{x:n,y:n,z:n});
  };

  btnScalePlus.onclick = () => {
    if (!panel2.getAttribute('visible')) return;
    const s = panel2.getAttribute('scale');
    let n = Math.min(maxScale, s.x * scaleStep);
    panel2.setAttribute('scale',{x:n,y:n,z:n});
  };

  btnColor.onclick = () => {
    if (!panel2.getAttribute('visible')) return;
    const colors=['#4CC3D9','#FFC65D','#7BC8A4','#EF2D5E','#FF0000','#FFFFFF'];
    const c = colors[Math.floor(Math.random()*colors.length)];
    const model = document.getElementById('model2');

    model.addEventListener('model-loaded', () => {
      model.getObject3D('mesh').traverse((node)=>{
        if(node.isMesh) node.material.color.set(c);
      });
    });
  };

  marker1.addEventListener('markerFound', () => {
    daliScanned = true;
  });

  marker2.addEventListener('markerFound', () => {
    if (!daliScanned) {
      panel2.setAttribute("visible", false);
      return;
    }
    panel2.setAttribute("visible", true);
  });

  marker2.addEventListener('markerLost', () => {
    panel2.setAttribute("visible", false);
  });

});
</script>

</body>
</html>
